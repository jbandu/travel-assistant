// Prisma Schema for Travel Assistant
// Database: Neon PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Simple admin authentication
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  role          String    @default("admin") // admin, user
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  // Relations
  profile       UserProfile?
  trips         Trip[]
  bookings      Booking[]
  conversations Conversation[]

  @@map("users")
}

// User Profile - Preferences and Customer 360 data
model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Travel Preferences (using JSONB for flexibility)
  preferences Json @default("{}")
  // Example structure:
  // {
  //   // Trip Planning Preferences
  //   "interests": ["beach", "culture", "adventure", "food", "nightlife", "nature", "history"],
  //   "travelStyle": "budget" | "mid-range" | "luxury",
  //   "preferredBudgetRange": { "min": 1000, "max": 5000, "currency": "USD" },
  //   "accommodationType": ["hotel", "hostel", "airbnb", "resort"],
  //   "activityLevel": "relaxed" | "moderate" | "active",
  //   "groupPreference": "solo" | "couple" | "family" | "friends",
  //
  //   // Travel History & Context
  //   "visitedCountries": ["USA", "FRA", "JPN"],
  //   "favoriteDestinations": ["Paris", "Tokyo", "New York"],
  //   "bucketList": ["Iceland", "New Zealand", "Machu Picchu"],
  //   "pastTrips": [{"destination": "Paris", "rating": 5, "highlights": "Eiffel Tower, Louvre"}],
  //
  //   // Flight Preferences
  //   "preferredCabinClass": "economy" | "premium_economy" | "business" | "first",
  //   "preferredAirlines": ["UA", "DL"],
  //   "seatPreference": "window" | "aisle" | "middle",
  //   "mealPreference": "vegetarian" | "vegan" | "halal" | "kosher" | "standard",
  //   "dietaryRestrictions": ["gluten-free", "nut-allergy"],
  //
  //   // Personal Context
  //   "age": 30,
  //   "occupation": "Software Engineer",
  //   "languages": ["English", "Spanish"],
  //   "timezone": "America/New_York",
  //
  //   // Notification Preferences
  //   "notificationPreferences": {
  //     "email": true,
  //     "sms": false,
  //     "push": true
  //   }
  // }

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_profiles")
}

// Trip model - Core trip planning data
model Trip {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  tripType    String?  @map("trip_type") // leisure, business, family
  status      String   @default("planning") // planning, booked, traveling, completed, cancelled

  // Dates and destinations
  startDate    DateTime  @map("start_date")
  endDate      DateTime  @map("end_date")
  destinations Json      @default("[]")
  // Example: [{"city": "Paris", "country": "FRA", "arrivalDate": "2024-06-01", "departureDate": "2024-06-05"}]

  // Budget
  budgetAmount   Decimal?  @map("budget_amount") @db.Decimal(10, 2)
  budgetCurrency String?   @map("budget_currency") @default("USD")
  actualSpent    Decimal   @default(0) @map("actual_spent") @db.Decimal(10, 2)

  // Travelers
  travelerCount   Int  @default(1) @map("traveler_count")
  travelerDetails Json @default("[]") @map("traveler_details")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  bookings      Booking[]
  conversations Conversation[]

  @@map("trips")
}

// Booking model - Flights, hotels, activities
model Booking {
  id              String   @id @default(uuid())
  tripId          String?  @map("trip_id")
  trip            Trip?    @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  bookingType     String   @map("booking_type") // flight, hotel, activity, car_rental
  status          String   @default("pending") // pending, confirmed, cancelled, completed

  // Booking references
  confirmationCode String?  @unique @map("confirmation_code")
  supplierReference String? @map("supplier_reference")
  supplierName     String?  @map("supplier_name")

  // Booking details (flexible JSONB)
  bookingDetails Json @map("booking_details")
  // For flights: {origin, destination, departureTime, arrivalTime, airline, flightNumber, passengers, seats}
  // For hotels: {hotelName, checkIn, checkOut, roomType, guests, address}
  // For activities: {activityName, date, time, location, participants}

  // Financial
  totalAmount     Decimal @map("total_amount") @db.Decimal(10, 2)
  currency        String  @default("USD")
  paymentStatus   String  @default("pending") @map("payment_status") // pending, paid, refunded, failed

  // Cancellation
  cancellable         Boolean   @default(true)
  cancellationDeadline DateTime? @map("cancellation_deadline")
  cancellationFee      Decimal?  @map("cancellation_fee") @db.Decimal(10, 2)

  bookingDate DateTime @default(now()) @map("booking_date")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("bookings")
}

// Conversation model - AI agent chat history
model Conversation {
  id      String  @id @default(uuid())
  userId  String  @map("user_id")
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tripId  String? @map("trip_id")
  trip    Trip?   @relation(fields: [tripId], references: [id], onDelete: SetNull)

  agentType String @map("agent_type") // trip_planning, search_booking, experience, support, customer360

  // Conversation context and messages stored as JSONB
  context  Json @default("{}")
  messages Json @default("[]")
  // messages format: [{"role": "user"|"agent", "content": "...", "timestamp": "...", "agentName": "..."}]

  status              String   @default("active") // active, closed, escalated
  escalatedToHuman    Boolean  @default(false) @map("escalated_to_human")
  escalationReason    String?  @map("escalation_reason")

  startedAt      DateTime  @default(now()) @map("started_at")
  lastMessageAt  DateTime  @default(now()) @map("last_message_at")
  closedAt       DateTime? @map("closed_at")

  @@map("conversations")
}

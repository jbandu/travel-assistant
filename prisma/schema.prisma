// Prisma Schema for Travel Assistant
// Database: Neon PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Simple admin authentication
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  role          String    @default("admin") // admin, user
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  // Subscription
  subscriptionPlan      String    @default("free") @map("subscription_plan") // free, traveler, explorer
  subscriptionStatus    String    @default("active") @map("subscription_status") // active, canceled, past_due, trialing
  stripeCustomerId      String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId  String?   @unique @map("stripe_subscription_id")
  subscriptionEndsAt    DateTime? @map("subscription_ends_at")
  trialEndsAt           DateTime? @map("trial_ends_at")

  // Relations
  profile             UserProfile?
  trips               Trip[]
  bookings            Booking[]
  conversations       Conversation[]
  linkedCompanions    TravelCompanion[] // When this user is linked as a companion
  travelNotes         TravelNote[]

  @@map("users")
}

// Subscription Tier Configuration (Admin-managed)
model SubscriptionTier {
  id          String   @id @default(uuid())
  tierCode    String   @unique @map("tier_code") // free, traveler, explorer
  name        String
  description String?

  // Pricing
  monthlyPrice  Float    @default(0) @map("monthly_price")
  yearlyPrice   Float    @default(0) @map("yearly_price")
  currency      String   @default("usd")

  // Stripe Integration
  stripeMonthlyPriceId String?  @unique @map("stripe_monthly_price_id")
  stripeYearlyPriceId  String?  @unique @map("stripe_yearly_price_id")
  stripeProductId      String?  @unique @map("stripe_product_id")

  // Trial
  trialDays     Int?     @map("trial_days")

  // Feature Limits
  maxTrips          Int?     @map("max_trips") // null = unlimited
  maxAIMessages     Int?     @map("max_ai_messages") // null = unlimited
  maxPriceAlerts    Int?     @map("max_price_alerts")
  maxFlightBookings Int?     @map("max_flight_bookings")
  maxHotelBookings  Int?     @map("max_hotel_bookings")
  maxBucketList     Int?     @map("max_bucket_list")

  // Feature Flags
  hasAdvancedAnalytics Boolean @default(false) @map("has_advanced_analytics")
  hasPrioritySupport   Boolean @default(false) @map("has_priority_support")
  hasCalendarSync      Boolean @default(false) @map("has_calendar_sync")
  hasPDFExport         Boolean @default(false) @map("has_pdf_export")
  hasConcierge         Boolean @default(false) @map("has_concierge")
  hasFamilyAccount     Boolean @default(false) @map("has_family_account")
  has24x7Support       Boolean @default(false) @map("has_24x7_support")

  // Display
  isActive      Boolean  @default(true) @map("is_active")
  isPopular     Boolean  @default(false) @map("is_popular")
  displayOrder  Int      @default(0) @map("display_order")

  // Metadata
  features      Json     @default("[]") // Array of feature descriptions

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("subscription_tiers")
}

// User Profile - Preferences and Customer 360 data
model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Legacy JSONB preferences (kept for backward compatibility)
  preferences Json @default("{}")

  // NEW: Structured profile data (Knowledge Graph)
  personalInfo      PersonalInfo?
  travelStyle       TravelStyle?
  dietary           DietaryProfile?
  accessibility     AccessibilityInfo?
  travelDocs        TravelDocuments?

  // Relations
  companions        TravelCompanion[]
  tripMemories      TripMemory[]
  bucketList        BucketListItem[]
  experiences       Experience[]

  // Engagement tracking
  profileCompletion Int      @default(0) @map("profile_completion")
  updateStreak      Int      @default(0) @map("update_streak")
  lastStreakDate    DateTime? @map("last_streak_date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_profiles")
}

// Personal Information
model PersonalInfo {
  id              String      @id @default(uuid())
  profileId       String      @unique @map("profile_id")
  profile         UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  middleName      String?     @map("middle_name")
  preferredName   String?     @map("preferred_name")
  dateOfBirth     DateTime?   @map("date_of_birth")
  gender          String?
  occupation      String?
  industry        String?

  // Location
  city            String?
  state           String?
  country         String?
  timezone        String?

  // Languages & culture
  languages       Json        @default("[]") // [{ language: "English", proficiency: "native" }]
  culturalBg      String?     @map("cultural_background")

  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@map("personal_info")
}

// Travel Style & Preferences
model TravelStyle {
  id                String      @id @default(uuid())
  profileId         String      @unique @map("profile_id")
  profile           UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  budgetLevel       String?     @map("budget_level") // budget/mid-range/luxury/ultra-luxury
  pacePreference    String?     @map("pace_preference") // slow/moderate/fast/jam-packed
  activityLevel     String?     @map("activity_level") // relaxed/moderate/active/extreme
  planningStyle     String?     @map("planning_style") // spontaneous/flexible/detailed/rigid

  accommodationPrefs Json       @default("[]") @map("accommodation_prefs") // ["hotel", "airbnb", "resort"]
  transportPrefs     Json       @default("[]") @map("transport_prefs") // ["flight", "train", "road-trip"]

  // Interests with intensity levels
  interests         Json        @default("[]") // [{ interest: "beach", intensity: 5, level: "enthusiast" }]

  // Flight preferences
  preferredCabinClass String?   @map("preferred_cabin_class") // economy/premium_economy/business/first
  seatPreference      String?   @map("seat_preference") // window/aisle/middle
  preferredAirlines   Json      @default("[]") @map("preferred_airlines")

  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@map("travel_styles")
}

// Dietary Profile
model DietaryProfile {
  id                String      @id @default(uuid())
  profileId         String      @unique @map("profile_id")
  profile           UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  restrictions      Json        @default("[]") // ["vegetarian", "gluten-free", "nut-allergy"]
  allergies         Json        @default("[]") // ["peanuts", "shellfish"]
  favoriteCuisines  Json        @default("[]") @map("favorite_cuisines") // ["Italian", "Japanese"]
  adventurousScore  Int?        @map("adventurous_score") // 1-10
  specificDislikes  Json        @default("[]") @map("specific_dislikes")

  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@map("dietary_profiles")
}

// Accessibility & Health Information
model AccessibilityInfo {
  id                  String      @id @default(uuid())
  profileId           String      @unique @map("profile_id")
  profile             UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  physicalLimitations Json        @default("[]") @map("physical_limitations")
  accessibilityNeeds  Json        @default("[]") @map("accessibility_needs")
  medicalNotes        String?     @map("medical_notes")
  fitnessLevel        String?     @map("fitness_level") // low/moderate/high/athlete

  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  @@map("accessibility_info")
}

// Travel Documents & Memberships
model TravelDocuments {
  id                String      @id @default(uuid())
  profileId         String      @unique @map("profile_id")
  profile           UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  passportNumber    String?     @map("passport_number")
  passportExpiry    DateTime?   @map("passport_expiry")
  passportCountry   String?     @map("passport_country")

  visaHistory       Json        @default("[]") @map("visa_history")
  loyaltyPrograms   Json        @default("[]") @map("loyalty_programs") // [{ program: "UA", number: "..." }]
  travelBenefits    Json        @default("[]") @map("travel_benefits") // ["TSA PreCheck", "Global Entry"]

  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@map("travel_documents")
}

// Trip model - Core trip planning data
model Trip {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  tripType    String?  @map("trip_type") // leisure, business, family
  status      String   @default("planning") // planning, booked, traveling, completed, cancelled

  // Dates and destinations
  startDate    DateTime  @map("start_date")
  endDate      DateTime  @map("end_date")
  destinations Json      @default("[]")
  // Example: [{"city": "Paris", "country": "FRA", "arrivalDate": "2024-06-01", "departureDate": "2024-06-05"}]

  // Budget
  budgetAmount   Decimal?  @map("budget_amount") @db.Decimal(10, 2)
  budgetCurrency String?   @map("budget_currency") @default("USD")
  actualSpent    Decimal   @default(0) @map("actual_spent") @db.Decimal(10, 2)

  // Travelers
  travelerCount   Int  @default(1) @map("traveler_count")
  travelerDetails Json @default("[]") @map("traveler_details")

  // NEW: Unified Planning Validation
  hasConflicts     Boolean   @default(false) @map("has_conflicts")
  lastValidatedAt  DateTime? @map("last_validated_at")
  conflictDetails  Json      @default("[]") @map("conflict_details")
  // [{ type: "DATE_OVERLAP", severity: "ERROR", message: "...", affectedBookings: [...] }]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  bookings      Booking[]
  conversations Conversation[]

  @@map("trips")
}

// Booking model - Flights, hotels, activities, car rentals
model Booking {
  id              String   @id @default(uuid())
  tripId          String?  @map("trip_id")
  trip            Trip?    @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  bookingType     String   @map("booking_type") // FLIGHT, HOTEL, CAR_RENTAL, ACTIVITY, RESTAURANT
  status          String   @default("MOCK_RESERVED") // MOCK_RESERVED, CONFIRMED, CANCELLED, EXPIRED

  // NEW: Structured fields for validation (required for cross-checking)
  startDate       DateTime  @map("start_date")
  endDate         DateTime? @map("end_date") // Null for point-in-time activities
  startLocation   String    @map("start_location") // City or airport code (e.g., "NYC", "PAR")
  endLocation     String?   @map("end_location") // For flights, car rentals (destination)

  // Booking references
  confirmationCode String?  @unique @map("confirmation_code") // Auto-generated mock confirmation
  supplierReference String? @map("supplier_reference")
  supplierName     String?  @map("supplier_name") // "American Airlines", "Hilton Paris"

  // Booking details (flexible JSONB - stores full Amadeus response)
  bookingDetails Json @map("booking_details")
  // For FLIGHT: Full FlightOffer from Amadeus
  // For HOTEL: Full HotelOffer from Amadeus
  // For CAR_RENTAL: Car rental details
  // For ACTIVITY: Activity details

  // Type-specific details (parsed from bookingDetails for quick access)
  flightDetails   Json? @map("flight_details") // { airline, flightNumber, cabin, segments: [...] }
  hotelDetails    Json? @map("hotel_details")  // { hotelName, roomType, amenities, address }
  carDetails      Json? @map("car_details")    // { carType, company, pickupLocation, dropoffLocation }
  activityDetails Json? @map("activity_details") // { name, duration, meetingPoint }

  // Financial
  totalAmount     Decimal @map("total_amount") @db.Decimal(10, 2)
  currency        String  @default("USD")
  paymentStatus   String  @default("pending") @map("payment_status") // pending, paid, refunded, failed

  // Cancellation
  cancellable         Boolean   @default(true)
  cancellationDeadline DateTime? @map("cancellation_deadline")
  cancellationFee      Decimal?  @map("cancellation_fee") @db.Decimal(10, 2)

  // Notes & metadata
  notes           String?
  tags            String[]  @default([]) // ["non-refundable", "priority-boarding", "breakfast-included"]

  bookingDate DateTime @default(now()) @map("booking_date")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([tripId, startDate])
  @@index([tripId, bookingType])
  @@index([userId])
  @@map("bookings")
}

// Conversation model - AI agent chat history
model Conversation {
  id      String  @id @default(uuid())
  userId  String  @map("user_id")
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tripId  String? @map("trip_id")
  trip    Trip?   @relation(fields: [tripId], references: [id], onDelete: SetNull)

  agentType String @map("agent_type") // trip_planning, search_booking, experience, support, customer360

  // Conversation context and messages stored as JSONB
  context  Json @default("{}")
  messages Json @default("[]")
  // messages format: [{"role": "user"|"agent", "content": "...", "timestamp": "...", "agentName": "..."}]

  status              String   @default("active") // active, closed, escalated
  escalatedToHuman    Boolean  @default(false) @map("escalated_to_human")
  escalationReason    String?  @map("escalation_reason")

  startedAt      DateTime  @default(now()) @map("started_at")
  lastMessageAt  DateTime  @default(now()) @map("last_message_at")
  closedAt       DateTime? @map("closed_at")

  @@map("conversations")
}

// === KNOWLEDGE GRAPH MODELS ===

// Travel Companions (Family, Friends)
model TravelCompanion {
  id                String      @id @default(uuid())
  profileId         String      @map("profile_id")
  profile           UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // If they're also a user, link their account
  linkedUserId      String?     @map("linked_user_id")
  linkedUser        User?       @relation(fields: [linkedUserId], references: [id], onDelete: SetNull)

  // Basic info
  firstName         String      @map("first_name")
  lastName          String      @map("last_name")
  relationship      String      // spouse/partner/child/parent/sibling/friend/colleague
  dateOfBirth       DateTime?   @map("date_of_birth")

  // Travel together stats
  travelFrequency   String?     @map("travel_frequency") // regular/occasional/rare
  decisionInfluence Int         @default(5) @map("decision_influence") // 1-10

  // Their preferences (simplified subset)
  preferences       Json        @default("{}")
  dietary           Json        @default("{}")
  accessibility     Json        @default("{}")

  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@index([profileId])
  @@map("travel_companions")
}

// Trip Memories - Detailed past trip records
model TripMemory {
  id                String      @id @default(uuid())
  profileId         String      @map("profile_id")
  profile           UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Trip details
  title             String
  destinations      Json        @default("[]") // [{ city: "Paris", country: "France", arrival: "2024-01-01" }]
  startDate         DateTime    @map("start_date")
  endDate           DateTime    @map("end_date")
  tripType          String      @map("trip_type") // leisure/business/family/solo/group

  // Companions
  companions        Json        @default("[]") // [{ id: "...", name: "...", relationship: "..." }]

  // Experience data
  rating            Int         // 1-5
  highlights        String[]    @default([])
  wouldReturn       String      @map("would_return") // yes/no/conditional
  lessonsLearned    String[]    @default([]) @map("lessons_learned")

  // Financial
  budgetPlanned     Decimal?    @map("budget_planned") @db.Decimal(10, 2)
  budgetActual      Decimal?    @map("budget_actual") @db.Decimal(10, 2)
  currency          String      @default("USD")

  // Media & notes
  photos            Json        @default("[]") // [{ url: "...", caption: "..." }]
  notes             String?

  // Sharing
  isPublic          Boolean     @default(false) @map("is_public")
  shareableSlug     String?     @unique @map("shareable_slug")

  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@index([profileId])
  @@index([startDate])
  @@map("trip_memories")
}

// Bucket List Items - Dream destinations
model BucketListItem {
  id                String      @id @default(uuid())
  profileId         String      @map("profile_id")
  profile           UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  destination       String
  country           String
  region            String?

  // Priority & timeline
  priority          String      // must-do/someday/dream
  timeframe         String?     // this-year/5-years/10-years/retirement
  status            String      @default("wishlist") // wishlist/researching/planning/booked/completed

  // Planning
  estimatedBudget   Decimal?    @map("estimated_budget") @db.Decimal(10, 2)
  currency          String      @default("USD")

  // Details
  companions        Json        @default("[]") // Who they want to go with
  experiences       String[]    @default([]) // Specific things they want to do
  notes             String?
  inspiration       Json        @default("[]") // Photos, articles, links

  // Metadata
  position          Int         @default(0) // For ordering
  dateAdded         DateTime    @default(now()) @map("date_added")
  targetDate        DateTime?   @map("target_date")
  completedDate     DateTime?   @map("completed_date")
  linkedTripId      String?     @map("linked_trip_id") // If completed, link to TripMemory

  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@index([profileId])
  @@index([priority])
  @@index([status])
  @@map("bucket_list_items")
}

// Experiences - Activities, restaurants, hotels, events
model Experience {
  id                String      @id @default(uuid())
  profileId         String      @map("profile_id")
  profile           UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  experienceType    String      @map("experience_type") // activity/restaurant/hotel/event/tour
  name              String
  destination       String
  city              String?
  country           String?

  // Experience details
  date              DateTime
  rating            Int         // 1-5
  review            String?
  photos            Json        @default("[]")

  // Context
  tripMemoryId      String?     @map("trip_memory_id") // Link to trip if applicable
  companions        Json        @default("[]")
  priceLevel        String?     @map("price_level") // budget/moderate/expensive/luxury

  // Knowledge graph tags
  tags              String[]    @default([]) // ["romantic", "instagram-worthy", "local-favorite"]

  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@index([profileId])
  @@index([experienceType])
  @@index([destination])
  @@map("experiences")
}

// Smart Travel Notes - Voice/text notes with LLM interpretation
model TravelNote {
  id                String      @id @default(uuid())
  userId            String      @map("user_id")
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Original input
  noteText          String      @map("note_text") @db.Text
  inputMethod       String      @default("text") @map("input_method") // text, voice
  voiceTranscript   String?     @map("voice_transcript") @db.Text

  // LLM-parsed structured data
  category          String      // hotel, restaurant, flight, seat, activity, general, transportation
  subject           String?     // Hotel name, restaurant name, flight number, etc.
  sentiment         String      @default("neutral") // positive, negative, neutral

  // Extracted details (JSON)
  parsedData        Json        @default("{}") @map("parsed_data")
  // Example: { "hotelName": "Marriott", "roomType": "Suite", "roomNumber": "402", "issue": "noisy", "recommendation": "avoid rooms facing street" }

  // Location
  locationName      String?     @map("location_name")
  city              String?
  country           String?
  latitude          Float?
  longitude         Float?
  placeId           String?     @map("place_id") // Google Places ID if applicable

  // Related entities
  relatedTripId     String?     @map("related_trip_id")
  relatedBookingId  String?     @map("related_booking_id")

  // Organization
  tags              String[]    @default([])
  isActionable      Boolean     @default(false) @map("is_actionable") // Requires action/reminder
  priority          String      @default("normal") // low, normal, high

  // Contradiction detection
  supersededById    String?     @map("superseded_by_id") // If overridden by newer note
  supersedes        String[]    @default([]) // IDs of notes this overrides
  hasContradiction  Boolean     @default(false) @map("has_contradiction")

  // Metadata
  noteDate          DateTime    @default(now()) @map("note_date") // When the experience happened

  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  reminders         TravelNoteReminder[]

  @@index([userId])
  @@index([category])
  @@index([sentiment])
  @@index([locationName])
  @@index([noteDate])
  @@map("travel_notes")
}

// Travel Note Reminders - Location and time-based notifications
model TravelNoteReminder {
  id                String      @id @default(uuid())
  noteId            String      @map("note_id")
  note              TravelNote  @relation(fields: [noteId], references: [id], onDelete: Cascade)
  userId            String      @map("user_id")

  // Trigger type
  triggerType       String      @map("trigger_type") // location, time, booking

  // Location-based trigger
  triggerLocationName   String?     @map("trigger_location_name")
  triggerLatitude       Float?      @map("trigger_latitude")
  triggerLongitude      Float?      @map("trigger_longitude")
  proximityRadius       Int?        @map("proximity_radius") // meters

  // Time-based trigger
  triggerTime           DateTime?   @map("trigger_time")
  reminderOffset        String?     @map("reminder_offset") // "1 day before", "2 hours before"

  // Booking-based trigger
  relatedBookingId      String?     @map("related_booking_id")
  triggerPhase          String?     @map("trigger_phase") // "seat_selection", "check_in", "at_destination"

  // Notification
  notificationSent      Boolean     @default(false) @map("notification_sent")
  notificationSentAt    DateTime?   @map("notification_sent_at")
  notificationChannel   String      @default("app") @map("notification_channel") // app, email, sms

  // Status
  isActive              Boolean     @default(true) @map("is_active")
  expiresAt             DateTime?   @map("expires_at")

  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")

  @@index([userId])
  @@index([triggerType])
  @@index([isActive])
  @@index([notificationSent])
  @@map("travel_note_reminders")
}
